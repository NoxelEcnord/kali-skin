#!/bin/bash
# kali-skin v2.0 - Advanced OS Transformer for Kali Linux 2026 (XFCE)
# Developer: ecnord (GitHub: NoxelEcnord)

MODE=$1
VARIANT=$2

show_help() {
    echo -e "\e[1;36mKali-Skin Theme Switcher v2.0\e[0m"
    echo "Usage: kali-skin [mode] [variant]"
    echo ""
    echo "Modes:"
    echo "  mac [dark|light] - macOS style (includes Plank dock)"
    echo "  win [dark|light] - Windows 11 style (Panel at bottom)"
    echo "  athena           - Athena OS style (Cyberpunk)"
    echo "  arch             - Arch Linux style"
    echo "  kali             - Default Kali Linux setup"
    echo "  setup            - Install all themes, docks, and fonts (Run first!)"
    echo ""
}

setup_themes() {
    echo -e "\e[1;34m[*] Setting up themes, icons, and docks...\e[0m"
    mkdir -p ~/.themes ~/.icons ~/.wallpapers
    
    echo "Installing required system packages (plank, arc-theme, neofetch, nautilus, etc.)..."
    sudo apt-get update && sudo apt-get install -y arc-theme papirus-icon-theme plank curl git tar unzip neofetch nautilus

    # Mac Theme (WhiteSur)
    if [ ! -d "$HOME/.themes/WhiteSur-Dark" ]; then
        echo -e "\e[1;32m[+] Downloading WhiteSur Mac Theme...\e[0m"
        rm -rf /tmp/WhiteSur-gtk-theme
        git clone --depth 1 https://github.com/vinceliuice/WhiteSur-gtk-theme.git /tmp/WhiteSur-gtk-theme
        /tmp/WhiteSur-gtk-theme/install.sh -d ~/.themes -t all -N glassy
        rm -rf /tmp/WhiteSur-gtk-theme
    fi
    if [ ! -d "$HOME/.icons/WhiteSur-dark" ]; then
        echo -e "\e[1;32m[+] Downloading WhiteSur Mac Icons...\e[0m"
        rm -rf /tmp/WhiteSur-icon-theme
        git clone --depth 1 https://github.com/vinceliuice/WhiteSur-icon-theme.git /tmp/WhiteSur-icon-theme
        /tmp/WhiteSur-icon-theme/install.sh -d ~/.icons -t all
        rm -rf /tmp/WhiteSur-icon-theme
    fi

    # Windows 11 Theme (Fluent)
    if [ ! -d "$HOME/.themes/Fluent-Dark" ]; then
        echo -e "\e[1;32m[+] Downloading Windows 11 Fluent Theme...\e[0m"
        rm -rf /tmp/Fluent-gtk-theme
        git clone --depth 1 https://github.com/vinceliuice/Fluent-gtk-theme.git /tmp/Fluent-gtk-theme
        /tmp/Fluent-gtk-theme/install.sh -d ~/.themes --tweaks blur round
        rm -rf /tmp/Fluent-gtk-theme
    fi
    if [ ! -d "$HOME/.icons/Fluent-dark" ]; then
        echo -e "\e[1;32m[+] Downloading Windows 11 Fluent Icons...\e[0m"
        rm -rf /tmp/Fluent-icon-theme
        git clone --depth 1 https://github.com/vinceliuice/Fluent-icon-theme.git /tmp/Fluent-icon-theme
        /tmp/Fluent-icon-theme/install.sh -d ~/.icons
        rm -rf /tmp/Fluent-icon-theme
    fi

    # Athena Theme (Sweet-Dark / Candy-icons)
    if [ ! -d "$HOME/.themes/Sweet-Dark" ]; then
        echo -e "\e[1;32m[+] Downloading Sweet Theme for Athena...\e[0m"
        curl -sL "https://github.com/EliverLara/Sweet/releases/download/v6.0/Sweet-Dark.tar.xz" | tar -xJ -C ~/.themes/
    fi
    if [ ! -d "$HOME/.icons/candy-icons" ]; then
        echo -e "\e[1;32m[+] Downloading Candy Icons...\e[0m"
        git clone --depth 1 https://github.com/EliverLara/candy-icons.git ~/.icons/candy-icons
    fi

    # Wallpapers
    echo -e "\e[1;32m[+] Downloading Wallpapers...\e[0m"
    curl -sL -o ~/.wallpapers/mac.jpg "https://images.unsplash.com/photo-1610312278520-bcc893a3ff1d?q=80&w=1920&auto=format&fit=crop" || true
    curl -sL -o ~/.wallpapers/win11.jpg "https://images.unsplash.com/photo-1618005182384-a83a8bd57fbe?q=80&w=1920&auto=format&fit=crop" || true
    curl -sL -o ~/.wallpapers/athena.jpg "https://images.unsplash.com/photo-1614729939124-032f0b56c9ce?q=80&w=1920&auto=format&fit=crop" || true
    curl -sL -o ~/.wallpapers/arch.png "https://images.unsplash.com/photo-1526374965328-7f61d4dc18c5?q=80&w=1920&auto=format&fit=crop" || true

    # Set Nautilus as default file manager
    xdg-mime default org.gnome.Nautilus.desktop inode/directory

    echo -e "\e[1;32m[!] Setup complete! You can now run 'kali-skin win' or 'kali-skin mac' etc.\e[0m"
}

apply_shell() {
    local os=$1
    local rc_file="$HOME/.zshrc"
    local bash_rc="$HOME/.bashrc"
    
    # Remove old blocks
    sed -i '/# --- KALI-SKIN START ---/,/# --- KALI-SKIN END ---/d' "$rc_file" 2>/dev/null || true
    sed -i '/# --- KALI-SKIN START ---/,/# --- KALI-SKIN END ---/d' "$bash_rc" 2>/dev/null || true

    local zsh_content=""
    local bash_content=""

    if [ "$os" == "mac" ]; then
        zsh_content="PROMPT=\" %B%F{green}%n@macbook%f%b:%B%F{blue}%~%f%b $ \"\nclear\nneofetch --ascii_distro Mac"
        bash_content="PS1='\[\e[01;32m\]\u@macbook\[\e[00m\]:\[\e[01;34m\]\w\[\e[00m\] $ '\nclear\nneofetch --ascii_distro Mac"
    elif [ "$os" == "win" ]; then
        zsh_content="PROMPT=\" %B%F{green}PS C:\\\\Users\\\\%n>%f%b \"\nclear\nneofetch --ascii_distro Windows11"
        bash_content="PS1='\[\e[01;32m\]PS C:\\Users\\\\\u>\[\e[00m\] '\nclear\nneofetch --ascii_distro Windows11"
    elif [ "$os" == "athena" ]; then
        zsh_content="PROMPT=\" %B%F{magenta}┌──(%f%b%F{cyan} athena%f%b%F{magenta})-[%f%b%F{yellow}%~%f%b%B%F{magenta}]\n└─%f%b%B%F{green}λ%f%b \"\nclear\nneofetch --ascii_distro BlackArch"
        bash_content="PS1='\[\e[01;35m\]┌──(\[\e[01;36m\] athena\[\e[01;35m\])-[\[\e[01;33m\]\w\[\e[01;35m\]]\n└─\[\e[01;32m\]λ\[\e[00m\] '\nclear\nneofetch --ascii_distro BlackArch"
    elif [ "$os" == "arch" ]; then
        zsh_content="PROMPT=\" %B%F{cyan}[%n@archlinux %1~]%f%b$ \"\nclear\nneofetch --ascii_distro Arch"
        bash_content="PS1='\[\e[01;36m\][\u@archlinux \W]\[\e[00m\]$ '\nclear\nneofetch --ascii_distro Arch"
    elif [ "$os" == "kali" ]; then
        zsh_content="clear\nneofetch --ascii_distro Kali"
        bash_content="clear\nneofetch --ascii_distro Kali"
    fi

    if [ -n "$zsh_content" ] && [ -f "$rc_file" ]; then
        echo "" >> "$rc_file"
        cat << EOF >> "$rc_file"
# --- KALI-SKIN START ---
$zsh_content
# --- KALI-SKIN END ---
EOF
    fi
    if [ -n "$bash_content" ] && [ -f "$bash_rc" ]; then
        echo "" >> "$bash_rc"
        cat << EOF >> "$bash_rc"
# --- KALI-SKIN START ---
$bash_content
# --- KALI-SKIN END ---
EOF
    fi
}

apply_login_and_boot() {
    local gtk_theme=$1
    local icon_theme=$2
    local wallpaper=$3
    local os=$4

    echo -e "\e[1;33m[!] Applying Login Screen and Boot Animation (Requires sudo password)...\e[0m"
    
    # LightDM Login Screen
    if [ -f "/etc/lightdm/lightdm-gtk-greeter.conf" ]; then
        sudo sed -i "s|^background = .*|background = $wallpaper|g" /etc/lightdm/lightdm-gtk-greeter.conf 2>/dev/null || echo "background = $wallpaper" | sudo tee -a /etc/lightdm/lightdm-gtk-greeter.conf > /dev/null
        sudo sed -i "s|^theme-name = .*|theme-name = $gtk_theme|g" /etc/lightdm/lightdm-gtk-greeter.conf 2>/dev/null || echo "theme-name = $gtk_theme" | sudo tee -a /etc/lightdm/lightdm-gtk-greeter.conf > /dev/null
        sudo sed -i "s|^icon-theme-name = .*|icon-theme-name = $icon_theme|g" /etc/lightdm/lightdm-gtk-greeter.conf 2>/dev/null || echo "icon-theme-name = $icon_theme" | sudo tee -a /etc/lightdm/lightdm-gtk-greeter.conf > /dev/null
    fi

    # Plymouth Boot Animation
    if command -v plymouth-set-default-theme &> /dev/null; then
        if [ "$os" == "mac" ] || [ "$os" == "win" ]; then
            sudo plymouth-set-default-theme -R spinner 2>/dev/null || true
        elif [ "$os" == "kali" ]; then
            sudo plymouth-set-default-theme -R kali 2>/dev/null || true
        fi
    fi
}

apply_xfce() {
    local gtk_theme=$1
    local icon_theme=$2
    local wm_theme=$3
    local wallpaper=$4
    local qterm_color=$5
    local panel_pos=$6
    local use_plank=$7

    if command -v xfconf-query &> /dev/null; then
        xfconf-query -c xsettings -p /Net/ThemeName -s "$gtk_theme" 2>/dev/null || xfconf-query -c xsettings -p /Net/ThemeName -n -t string -s "$gtk_theme"
        xfconf-query -c xsettings -p /Net/IconThemeName -s "$icon_theme" 2>/dev/null || xfconf-query -c xsettings -p /Net/IconThemeName -n -t string -s "$icon_theme"
        xfconf-query -c xfwm4 -p /general/theme -s "$wm_theme" 2>/dev/null || xfconf-query -c xfwm4 -p /general/theme -n -t string -s "$wm_theme"
        
        for p in $(xfconf-query -c xfce4-desktop -l 2>/dev/null | grep "last-image"); do
            xfconf-query -c xfce4-desktop -p "$p" -s "$wallpaper" 2>/dev/null
        done

        # Move panel
        if [ "$panel_pos" == "top" ]; then
            xfconf-query -c xfce4-panel -p /panels/panel-1/position -s "p=8;x=0;y=0" 2>/dev/null
        elif [ "$panel_pos" == "bottom" ]; then
            xfconf-query -c xfce4-panel -p /panels/panel-1/position -s "p=10;x=0;y=0" 2>/dev/null
        fi
    fi

    # Terminal themes (QTerminal)
    if [ -f "$HOME/.config/qterminal.org/qterminal.ini" ] && [ -n "$qterm_color" ]; then
        if grep -q "colorScheme=" "$HOME/.config/qterminal.org/qterminal.ini"; then
            sed -i "s/colorScheme=. */colorScheme=$qterm_color/g" "$HOME/.config/qterminal.org/qterminal.ini"
        else
            sed -i "/\[General\]/a colorScheme=$qterm_color" "$HOME/.config/qterminal.org/qterminal.ini"
        fi
    fi

    # Plank
    if [ "$use_plank" == "yes" ]; then
        if command -v dconf &> /dev/null; then
            dconf write /net/launchpad/plank/docks/dock1/position "'bottom'"
            dconf write /net/launchpad/plank/docks/dock1/icon-size 32
        fi
        if ! pgrep -x "plank" > /dev/null; then
            plank &disown > /dev/null 2>&1
        fi
    else
        killall plank 2>/dev/null || true
    fi
}

case "$MODE" in
    setup)
        setup_themes
        ;;
    mac)
        GTK="WhiteSur-Dark" && ICO="WhiteSur-dark"
        if [ "$VARIANT" == "--light" ] || [ "$VARIANT" == "light" ]; then GTK="WhiteSur-Light" && ICO="WhiteSur"; fi
        echo "Applying macOS Theme ($GTK)..."
        apply_xfce "$GTK" "$ICO" "$GTK" "$HOME/.wallpapers/mac.jpg" "WhiteOnBlack" "top" "yes"
        apply_shell "mac"
        apply_login_and_boot "$GTK" "$ICO" "$HOME/.wallpapers/mac.jpg" "mac"
        echo "Done! Please open a new terminal."
        ;;
    win)
        GTK="Fluent-Dark" && ICO="Fluent-dark"
        if [ "$VARIANT" == "--light" ] || [ "$VARIANT" == "light" ]; then GTK="Fluent-Light" && ICO="Fluent"; fi
        echo "Applying Windows 11 Theme ($GTK)..."
        apply_xfce "$GTK" "$ICO" "$GTK" "$HOME/.wallpapers/win11.jpg" "WhiteOnBlack" "bottom" "no"
        apply_shell "win"
        apply_login_and_boot "$GTK" "$ICO" "$HOME/.wallpapers/win11.jpg" "win"
        echo "Done! Please open a new terminal."
        ;;
    athena)
        echo "Applying Athena OS Theme..."
        apply_xfce "Sweet-Dark" "candy-icons" "Sweet-Dark" "$HOME/.wallpapers/athena.jpg" "GreenOnBlack" "top" "no"
        apply_shell "athena"
        apply_login_and_boot "Sweet-Dark" "candy-icons" "$HOME/.wallpapers/athena.jpg" "athena"
        echo "Done! Please open a new terminal."
        ;;
    arch)
        echo "Applying Arch Linux Theme..."
        apply_xfce "Arc-Dark" "Papirus-Dark" "Arc-Dark" "$HOME/.wallpapers/arch.png" "SolarizedDark" "top" "no"
        apply_shell "arch"
        apply_login_and_boot "Arc-Dark" "Papirus-Dark" "$HOME/.wallpapers/arch.png" "arch"
        echo "Done! Please open a new terminal."
        ;;
    kali)
        echo "Applying default Kali Theme..."
        KALI_BG=$(find /usr/share/backgrounds/kali -type f -name '*default*' | head -n 1 2>/dev/null)
        if [ -z "$KALI_BG" ]; then KALI_BG="/usr/share/backgrounds/kali-16x9/default"; fi
        apply_xfce "Kali-Dark" "Flat-Remix-Blue-Dark" "Kali-Dark" "$KALI_BG" "ali" "top" "no"
        apply_shell "kali"
        apply_login_and_boot "Kali-Dark" "Flat-Remix-Blue-Dark" "$KALI_BG" "kali"
        echo "Done! Please open a new terminal."
        ;;
    *)
        show_help
        ;;
esac